# -*- coding: utf-8 -*-
"""ForeSense.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1uEF2W8nKv3g8IQ-LCBaCf_9i3aQUU4PW
"""

import pandas as pd

data_sclad = pd.read_csv('/content/–ü—Ä–æ–¥–∞–∂–∏ —Å–æ —Å–∫–ª–∞–¥–æ–≤ 41175635.csv')

data_sclad.head(30)

import pandas as pd
import plotly.graph_objs as go
import plotly.subplots as sp

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
file_path = '–ü—Ä–æ–¥–∞–∂–∏ —Å–æ —Å–∫–ª–∞–¥–æ–≤ 41175635.csv'
with open(file_path, 'r', encoding='utf-8') as f:
    lines = f.readlines()

# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É (–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –¥–∞—Ç–∞–º–∏, –Ω–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω)
data_lines = lines[1:]

# –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫–∏
parsed_data = []
for line in data_lines:
    parts = line.strip().split(';')
    warehouse = parts[0]
    values = parts[1:]
    for i in range(0, len(values) - 1, 2):
        date_index = i // 2
        sales = values[i]
        stock = values[i + 1]
        parsed_data.append((warehouse, date_index, sales, stock))

# –°–æ–∑–¥–∞—ë–º DataFrame
df = pd.DataFrame(parsed_data, columns=['–°–∫–ª–∞–¥', '–ò–Ω–¥–µ–∫—Å_–¥–∞—Ç—ã', '–ü—Ä–æ–¥–∞–∂–∏', '–û—Å—Ç–∞—Ç–∫–∏'])
df['–ò–Ω–¥–µ–∫—Å_–¥–∞—Ç—ã'] = df['–ò–Ω–¥–µ–∫—Å_–¥–∞—Ç—ã'].astype(int)
df['–ü—Ä–æ–¥–∞–∂–∏'] = pd.to_numeric(df['–ü—Ä–æ–¥–∞–∂–∏'], errors='coerce')
df['–û—Å—Ç–∞—Ç–∫–∏'] = pd.to_numeric(df['–û—Å—Ç–∞—Ç–∫–∏'], errors='coerce')

# –°–æ–∑–¥–∞—ë–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
fig = sp.make_subplots(rows=2, cols=1, shared_xaxes=True, subplot_titles=("–ü—Ä–æ–¥–∞–∂–∏", "–û—Å—Ç–∞—Ç–∫–∏"))

# –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º
for —Å–∫–ª–∞–¥ in df['–°–∫–ª–∞–¥'].unique():
    subset = df[df['–°–∫–ª–∞–¥'] == —Å–∫–ª–∞–¥]
    fig.add_trace(
        go.Scatter(x=subset['–ò–Ω–¥–µ–∫—Å_–¥–∞—Ç—ã'], y=subset['–ü—Ä–æ–¥–∞–∂–∏'], mode='lines', name=f'{—Å–∫–ª–∞–¥} –ø—Ä–æ–¥–∞–∂–∏'),
        row=1, col=1
    )
    fig.add_trace(
        go.Scatter(x=subset['–ò–Ω–¥–µ–∫—Å_–¥–∞—Ç—ã'], y=subset['–û—Å—Ç–∞—Ç–∫–∏'], mode='lines', name=f'{—Å–∫–ª–∞–¥} –æ—Å—Ç–∞—Ç–∫–∏'),
        row=2, col=1
    )

# –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫–µ—Ç
fig.update_layout(height=1200, width=2000, title_text="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å–∫–ª–∞–¥–∞–º")
fig.show()

import pandas as pd
import matplotlib.pyplot as plt

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
file_path = "WB - 41175635 - –ü—Ä–æ–¥–∞–∂–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∏ - 01.09.2021-17.04.2025 - (18.04.2025).csv"
df = pd.read_csv(file_path, sep=';')

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤
df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'], errors='coerce')
df['–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ'] = pd.to_numeric(df['–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ'], errors='coerce')
df['–í—ã—Ä—É—á–∫–∞'] = pd.to_numeric(df['–í—ã—Ä—É—á–∫–∞'], errors='coerce')

# –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∏ –æ—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤
df_clean = df[['–î–∞—Ç–∞', '–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ', '–í—ã—Ä—É—á–∫–∞']].dropna()
df_clean = df_clean.sort_values('–î–∞—Ç–∞').reset_index(drop=True)

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏–∫–∏ –ø—Ä–æ–¥–∞–∂
plt.figure(figsize=(14, 5))
plt.plot(df_clean['–î–∞—Ç–∞'], df_clean['–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ'], label='–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ')
plt.title('–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥–∞–∂–∏')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂')
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# –ï—Å–ª–∏ df_clean —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏–º —Å—Ç–æ–ª–±–µ—Ü —Ü–µ–Ω—ã –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
df_clean['–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É'] = df_clean['–í—ã—Ä—É—á–∫–∞'] / df_clean['–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ']

# –ì—Ä–∞—Ñ–∏–∫: –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥–∞–∂ –æ—Ç —Ü–µ–Ω—ã
plt.figure(figsize=(10, 6))
sns.scatterplot(x='–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É', y='–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ', data=df_clean)
plt.title('–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥–∞–∂ –æ—Ç —Ü–µ–Ω—ã –∑–∞ –µ–¥–∏–Ω–∏—Ü—É')
plt.xlabel('–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (—Ä—É–±.)')
plt.ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂')
plt.grid(True)
plt.tight_layout()
plt.show()

print(df_clean.describe())
print(df_clean.corr(numeric_only=True))

import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ df_clean —É–∂–µ —Å–æ–∑–¥–∞–Ω, –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫–∏:
# '–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ', '–í—ã—Ä—É—á–∫–∞', '–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É'

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
print("–û–ø–∏—Å–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
print(df_clean.describe())

# –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞
corr_matrix = df_clean.corr(numeric_only=True)

# –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞
plt.figure(figsize=(8, 6))
sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', fmt=".2f", linewidths=0.5)
plt.title('–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É —á–∏—Å–ª–æ–≤—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏')
plt.tight_layout()
plt.show()

df_clean['–ú–µ—Å—è—Ü'] = df_clean['–î–∞—Ç–∞'].dt.month
df_clean['–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏'] = df_clean['–î–∞—Ç–∞'].dt.dayofweek

plt.figure(figsize=(10, 5))
sns.boxplot(x='–ú–µ—Å—è—Ü', y='–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ', data=df_clean)
plt.title('–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ—Å—è—Ü–∞–º')
plt.show()

df_clean['7–¥–Ω_—Å–∫–æ–ª—å–∑—è—â–µ–µ'] = df_clean['–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ'].rolling(window=7).mean()

plt.figure(figsize=(14, 6))
plt.plot(df_clean['–î–∞—Ç–∞'], df_clean['–ü—Ä–æ–¥–∞–∂–∏, –∫–æ–ª-–≤–æ'], label='–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥–∞–∂–∏', alpha=0.5)
plt.plot(df_clean['–î–∞—Ç–∞'], df_clean['7–¥–Ω_—Å–∫–æ–ª—å–∑—è—â–µ–µ'], label='–°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ (7 –¥–Ω–µ–π)', color='red')
plt.legend()
plt.title('–ü—Ä–æ–¥–∞–∂–∏ –∏ —Ç—Ä–µ–Ω–¥')
plt.show()

import pandas as pd
import matplotlib.pyplot as plt

# === –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞ ===
file_path = "–ü—Ä–æ–¥–∞–∂–∏ —Å–æ —Å–∫–ª–∞–¥–æ–≤ 41175635.csv"
with open(file_path, 'r', encoding='utf-8') as f:
    lines = f.readlines()

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞—Ç –∏–∑ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
raw_dates = lines[0].strip().split(';')
dates = [d for d in raw_dates if '-' in d]

# –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫, –ø—Ä–æ–ø—É—Å–∫–∞—è –∑–∞–≥–æ–ª–æ–≤–∫–∏
parsed_data = []
for line in lines[1:]:
    parts = line.strip().split(';')
    warehouse = parts[0]
    values = parts[1:]
    for i in range(0, len(values) - 1, 2):
        date_index = i // 2
        if date_index < len(dates):
            sales = values[i]
            stock = values[i + 1]
            parsed_data.append((warehouse, dates[date_index], sales, stock))

# === –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞ ===
df_wh = pd.DataFrame(parsed_data, columns=['–°–∫–ª–∞–¥', '–î–∞—Ç–∞', '–ü—Ä–æ–¥–∞–∂–∏', '–û—Å—Ç–∞—Ç–∫–∏'])
df_wh = df_wh[df_wh['–°–∫–ª–∞–¥'] != '–°–∫–ª–∞–¥']  # —É–¥–∞–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–≥–æ–ª–æ–≤–∫–∏

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤
df_wh['–î–∞—Ç–∞'] = pd.to_datetime(df_wh['–î–∞—Ç–∞'], format="%d-%m", errors='coerce')
df_wh['–ü—Ä–æ–¥–∞–∂–∏'] = pd.to_numeric(df_wh['–ü—Ä–æ–¥–∞–∂–∏'], errors='coerce')
df_wh['–û—Å—Ç–∞—Ç–∫–∏'] = pd.to_numeric(df_wh['–û—Å—Ç–∞—Ç–∫–∏'], errors='coerce')

# === –ê–≥—Ä–µ–≥–∞—Ü–∏—è: —Å—É–º–º–∞—Ä–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º ===
pivot = df_wh.groupby('–°–∫–ª–∞–¥')['–ü—Ä–æ–¥–∞–∂–∏'].sum().sort_values(ascending=False)

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ —Å–∫–ª–∞–¥—ã —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º–∏ –ø—Ä–æ–¥–∞–∂–∞–º–∏
pivot_filtered = pivot[pivot > 0]

# === –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ===
plt.figure(figsize=(12, 6))
pivot_filtered.plot(kind='bar')
plt.title('–°—É–º–º–∞—Ä–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º (—Ç–æ–ª—å–∫–æ –≥–¥–µ –µ—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∏)')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.xlabel('–°–∫–ª–∞–¥')
plt.xticks(rotation=45, ha='right')
plt.grid(axis='y')
plt.tight_layout()
plt.show()

import pandas as pd
import matplotlib.pyplot as plt

# === –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: —Å—É–º–º–∞—Ä–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º ===
sales_by_warehouse = df_wh.groupby('–°–∫–ª–∞–¥', as_index=False)['–ü—Ä–æ–¥–∞–∂–∏'].sum()
sales_by_warehouse = sales_by_warehouse[sales_by_warehouse['–ü—Ä–æ–¥–∞–∂–∏'] > 0]
sales_by_warehouse = sales_by_warehouse.sort_values(by='–ü—Ä–æ–¥–∞–∂–∏', ascending=False)

# === –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ ===
plt.figure(figsize=(12, 6))
plt.bar(sales_by_warehouse['–°–∫–ª–∞–¥'], sales_by_warehouse['–ü—Ä–æ–¥–∞–∂–∏'])
plt.title('–°—É–º–º–∞—Ä–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º')
plt.xlabel('–°–∫–ª–∞–¥')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.xticks(rotation=45, ha='right')
plt.grid(axis='y')
plt.tight_layout()
plt.show()

import plotly.graph_objects as go

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
sales_by_warehouse = df_wh.groupby('–°–∫–ª–∞–¥', as_index=False)['–ü—Ä–æ–¥–∞–∂–∏'].sum()
sales_by_warehouse = sales_by_warehouse[sales_by_warehouse['–ü—Ä–æ–¥–∞–∂–∏'] > 0]
sales_by_warehouse = sales_by_warehouse.sort_values(by='–ü—Ä–æ–¥–∞–∂–∏', ascending=False)
sales_by_warehouse = sales_by_warehouse.reset_index(drop=True)
sales_by_warehouse.index += 1

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
fig = go.Figure(data=[go.Table(
    header=dict(values=['#', '–°–∫–ª–∞–¥', '–ü—Ä–æ–¥–∞–∂–∏'], fill_color='lightgray', align='left'),
    cells=dict(values=[
        sales_by_warehouse.index,
        sales_by_warehouse['–°–∫–ª–∞–¥'],
        sales_by_warehouse['–ü—Ä–æ–¥–∞–∂–∏']
    ],
    align='left'))
])

fig.update_layout(title='–°—É–º–º–∞—Ä–Ω—ã–µ –ü—Ä–æ–¥–∞–∂–∏ –ü–æ –°–∫–ª–∞–¥–∞–º')
fig.show()

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# === 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö ===
file_path = "–ü—Ä–æ–¥–∞–∂–∏ —Å–æ —Å–∫–ª–∞–¥–æ–≤ 41175635.csv"
with open(file_path, 'r', encoding='utf-8') as f:
    lines = f.readlines()

# –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã
raw_dates = lines[0].strip().split(';')
dates = [d for d in raw_dates if '-' in d]
date_map = pd.Series(pd.to_datetime(dates, format='%d-%m', errors='coerce'))

# –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫
parsed_data = []
for line in lines[1:]:
    parts = line.strip().split(';')
    warehouse = parts[0]
    values = parts[1:]
    for i in range(0, len(values) - 1, 2):
        index = i // 2
        if index < len(date_map):
            sales = values[i]
            stock = values[i + 1]
            parsed_data.append((warehouse, index, date_map[index], sales, stock))

# === 2. –°–æ–∑–¥–∞–Ω–∏–µ DataFrame ===
df_wh = pd.DataFrame(parsed_data, columns=['–°–∫–ª–∞–¥', '–ò–Ω–¥–µ–∫—Å_–¥–∞—Ç—ã', '–î–∞—Ç–∞', '–ü—Ä–æ–¥–∞–∂–∏', '–û—Å—Ç–∞—Ç–∫–∏'])
df_wh = df_wh[df_wh['–°–∫–ª–∞–¥'] != '–°–∫–ª–∞–¥']  # —É–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
df_wh['–ü—Ä–æ–¥–∞–∂–∏'] = pd.to_numeric(df_wh['–ü—Ä–æ–¥–∞–∂–∏'], errors='coerce')
df_wh['–û—Å—Ç–∞—Ç–∫–∏'] = pd.to_numeric(df_wh['–û—Å—Ç–∞—Ç–∫–∏'], errors='coerce')

# === 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –∏ –º–µ—Å—è—Ü–∞ ===
df_wh['–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏'] = df_wh['–î–∞—Ç–∞'].dt.dayofweek
df_wh['–ú–µ—Å—è—Ü'] = df_wh['–î–∞—Ç–∞'].dt.month

# === 4. –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º ===
corrs = []
for —Å–∫–ª–∞–¥, group in df_wh.groupby('–°–∫–ª–∞–¥'):
    if group['–ü—Ä–æ–¥–∞–∂–∏'].notna().sum() > 10:
        corr_w = group[['–ü—Ä–æ–¥–∞–∂–∏', '–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏']].corr().iloc[0, 1]
        corr_m = group[['–ü—Ä–æ–¥–∞–∂–∏', '–ú–µ—Å—è—Ü']].corr().iloc[0, 1]
        corrs.append({'–°–∫–ª–∞–¥': —Å–∫–ª–∞–¥, '–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏': corr_w, '–ú–µ—Å—è—Ü': corr_m})

df_corrs = pd.DataFrame(corrs).set_index('–°–∫–ª–∞–¥')

# === 5. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã ===
plt.figure(figsize=(12, 8))
sns.heatmap(df_corrs, annot=True, cmap='coolwarm', center=0, linewidths=0.5)
plt.title('–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ–∂–¥—É –ø—Ä–æ–¥–∞–∂–∞–º–∏ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º –ø–æ —Å–∫–ª–∞–¥–∞–º')
plt.tight_layout()
plt.show()

import pandas as pd

# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ df_wh —É–∂–µ —Å–æ–∑–¥–∞–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫–∏:
# '–°–∫–ª–∞–¥', '–ü—Ä–æ–¥–∞–∂–∏'

# === –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏ —Ä–∞—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫ ===
summary_stats = df_wh.groupby('–°–∫–ª–∞–¥').agg({
    '–ü—Ä–æ–¥–∞–∂–∏': [
        'mean',                        # —Å—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞
        'std',                         # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
        lambda x: (x == 0).mean()      # –¥–æ–ª—è –Ω—É–ª–µ–≤—ã—Ö –ø—Ä–æ–¥–∞–∂
    ]
}).reset_index()

# –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
summary_stats.columns = ['–°–∫–ª–∞–¥', '–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞', '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ', '–î–æ–ª—è –Ω—É–ª–µ–≤—ã—Ö –ø—Ä–æ–¥–∞–∂']

# –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—é (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ —Å—Ç–æ–ª–±—Ü—ã)
summary_stats = summary_stats.sort_values(by='–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ', ascending=False)

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
print(summary_stats)

import pandas as pd
import matplotlib.pyplot as plt
from sklearn.linear_model import LinearRegression

# === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ===
—Å–∫–ª–∞–¥ = '–ö–æ–ª–µ–¥–∏–Ω–æ WB'  # ‚Üê –º–æ–∂–µ—à—å –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π

# === –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
df_sklad = df_wh[df_wh['–°–∫–ª–∞–¥'] == —Å–∫–ª–∞–¥].copy()
df_sklad = df_sklad.dropna(subset=['–î–∞—Ç–∞', '–ü—Ä–æ–¥–∞–∂–∏']).sort_values('–î–∞—Ç–∞')
df_sklad['–î–∞—Ç–∞_—á–∏—Å–ª–æ'] = (df_sklad['–î–∞—Ç–∞'] - df_sklad['–î–∞—Ç–∞'].min()).dt.days

# === –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ ===
X = df_sklad[['–î–∞—Ç–∞_—á–∏—Å–ª–æ']]
y = df_sklad['–ü—Ä–æ–¥–∞–∂–∏']
model = LinearRegression().fit(X, y)
df_sklad['–¢—Ä–µ–Ω–¥'] = model.predict(X)

# === –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ===
plt.figure(figsize=(14, 6))
plt.plot(df_sklad['–î–∞—Ç–∞'], df_sklad['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥–∞–∂–∏', alpha=0.6)
plt.plot(df_sklad['–î–∞—Ç–∞'], df_sklad['–¢—Ä–µ–Ω–¥'], label='–õ–∏–Ω–µ–π–Ω—ã–π —Ç—Ä–µ–Ω–¥', color='red')
plt.title(f'–õ–∏–Ω–µ–π–Ω—ã–π —Ç—Ä–µ–Ω–¥ –ø–æ —Å–∫–ª–∞–¥—É: {—Å–∫–ª–∞–¥}')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

# === –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –Ω–∞–∫–ª–æ–Ω–∞ ===
–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = model.coef_[0]
print(f"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –Ω–∞–∫–ª–æ–Ω–∞ —Ç—Ä–µ–Ω–¥–∞ –¥–ª—è {—Å–∫–ª–∞–¥}: {–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç:.2f}")

# === –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è ===
if –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç > 0:
    print("üîº –ü—Ä–æ–¥–∞–∂–∏ —Ä–∞—Å—Ç—É—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º (–≤ —Å—Ä–µ–¥–Ω–µ–º).")
elif –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç < 0:
    print("üîΩ –ü—Ä–æ–¥–∞–∂–∏ —Å–Ω–∏–∂–∞—é—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.")
else:
    print("‚ûñ –ü—Ä–æ–¥–∞–∂–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã (–Ω–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞).")

import pandas as pd
from sklearn.linear_model import LinearRegression

# –°–ø–∏—Å–æ–∫ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
trend_data = []

# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∫–ª–∞–¥—É
for —Å–∫–ª–∞–¥, group in df_wh.groupby('–°–∫–ª–∞–¥'):
    group = group.dropna(subset=['–î–∞—Ç–∞', '–ü—Ä–æ–¥–∞–∂–∏']).sort_values('–î–∞—Ç–∞')
    if len(group) >= 10:
        group['–î–∞—Ç–∞_—á–∏—Å–ª–æ'] = (group['–î–∞—Ç–∞'] - group['–î–∞—Ç–∞'].min()).dt.days
        X = group[['–î–∞—Ç–∞_—á–∏—Å–ª–æ']]
        y = group['–ü—Ä–æ–¥–∞–∂–∏']

        try:
            model = LinearRegression().fit(X, y)
            –∫–æ—ç—Ñ = model.coef_[0]

            if –∫–æ—ç—Ñ > 0.5:
                –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è = '–ü—Ä–æ–¥–∞–∂–∏ —Ä–∞—Å—Ç—É—Ç'
            elif –∫–æ—ç—Ñ < -0.5:
                –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è = '–ü—Ä–æ–¥–∞–∂–∏ –ø–∞–¥–∞—é—Ç'
            else:
                –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è = '–ü—Ä–æ–¥–∞–∂–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã'

            trend_data.append({
                '–°–∫–ª–∞–¥': —Å–∫–ª–∞–¥,
                '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –Ω–∞–∫–ª–æ–Ω–∞': round(–∫–æ—ç—Ñ, 2),
                '–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è': –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
            })
        except:
            pass  # –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫–ª–∞–¥, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤ –º–æ–¥–µ–ª–∏

# –í DataFrame
df_trends = pd.DataFrame(trend_data).sort_values(by='–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –Ω–∞–∫–ª–æ–Ω–∞', ascending=False)
print(df_trends)

"""–ü—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—é

"""

print(sales_long.columns)

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime

# === 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ ===
file_path = "–ü—Ä–æ–¥–∞–∂–∏ —Å–æ —Å–∫–ª–∞–¥–æ–≤ 41175635.csv"
with open(file_path, 'r', encoding='utf-8') as f:
    lines = f.readlines()

# –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã –∏–∑ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
raw_dates = lines[0].strip().split(';')
dates = [d for d in raw_dates if '-' in d]

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–¥–∞
parsed_dates = []
current_year = 2021
last_month = 0

for d in dates:
    day, month = map(int, d.split('-'))
    if last_month == 12 and month == 1:
        current_year += 1
    try:
        dt = datetime(current_year, month, day)
        parsed_dates.append(dt)
        last_month = month
    except ValueError:
        parsed_dates.append(None)

date_map = pd.Series(parsed_dates)

# –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫
parsed_data = []
for line in lines[1:]:
    parts = line.strip().split(';')
    warehouse = parts[0]
    values = parts[1:]
    for i in range(0, len(values) - 1, 2):  # —à–∞–≥ 2: –ü—Ä–æ–¥–∞–∂–∏ / –û—Å—Ç–∞—Ç–∫–∏
        index = i // 2
        if index < len(date_map):
            sales = values[i]
            stock = values[i + 1]
            parsed_data.append((warehouse, index, date_map[index], sales, stock))

# === 2. –°–æ–∑–¥–∞–Ω–∏–µ DataFrame –ø–æ —Å–∫–ª–∞–¥–∞–º ===
df_wh = pd.DataFrame(parsed_data, columns=['–°–∫–ª–∞–¥', '–ò–Ω–¥–µ–∫—Å_–¥–∞—Ç—ã', '–î–∞—Ç–∞', '–ü—Ä–æ–¥–∞–∂–∏', '–û—Å—Ç–∞—Ç–∫–∏'])
df_wh = df_wh[df_wh['–°–∫–ª–∞–¥'] != '–°–∫–ª–∞–¥']  # —É–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
df_wh['–ü—Ä–æ–¥–∞–∂–∏'] = pd.to_numeric(df_wh['–ü—Ä–æ–¥–∞–∂–∏'], errors='coerce')
df_wh['–û—Å—Ç–∞—Ç–∫–∏'] = pd.to_numeric(df_wh['–û—Å—Ç–∞—Ç–∫–∏'], errors='coerce')

# –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –¥–∞—Ç—ã
df_wh = df_wh[df_wh['–î–∞—Ç–∞'].notna()]

# === 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ ===
df_wh['–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏'] = df_wh['–î–∞—Ç–∞'].dt.dayofweek
df_wh['–ú–µ—Å—è—Ü'] = df_wh['–î–∞—Ç–∞'].dt.month

# === 4. –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ===
weather_df = pd.read_csv("moscow.csv")
weather_df["date"] = pd.to_datetime(weather_df["date"])

# === 5. –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Å–∫–ª–∞–¥—ã ===
target_warehouses = ['–ö–æ–ª–µ–¥–∏–Ω–æ WB', '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å WB']
df_filtered = df_wh[df_wh['–°–∫–ª–∞–¥'].isin(target_warehouses)].copy()

# === 6. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π ===
df_final = df_filtered.merge(weather_df[['date', 'tavg', 'prcp']], left_on='–î–∞—Ç–∞', right_on='date', how='left')
df_final.drop(columns='date', inplace=True)

# === 7. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ===
print(df_final.head())

# (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª
# df_final.to_csv("–∏—Ç–æ–≥_–ø—Ä–æ–¥–∞–∂–∏_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞.csv", index=False)

import seaborn as sns
import matplotlib.pyplot as plt

# === 1. –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–¥–∞–∂ –æ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∫–ª–∞–¥—É ===
for warehouse in df_final['–°–∫–ª–∞–¥'].unique():
    subset = df_final[df_final['–°–∫–ª–∞–¥'] == warehouse]

    plt.figure(figsize=(10, 5))
    sns.scatterplot(data=subset, x='tavg', y='–ü—Ä–æ–¥–∞–∂–∏', alpha=0.5)
    plt.title(f'–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂ –æ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã: {warehouse}')
    plt.xlabel('–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)')
    plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
    plt.grid(True)
    plt.show()

# === 2. –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∫–ª–∞–¥—É ===
for warehouse in df_final['–°–∫–ª–∞–¥'].unique():
    subset = df_final[df_final['–°–∫–ª–∞–¥'] == warehouse]
    correlation = subset[['–ü—Ä–æ–¥–∞–∂–∏', 'tavg']].corr().iloc[0, 1]
    print(f"–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ–∂–¥—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π –∏ –ø—Ä–æ–¥–∞–∂–∞–º–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞ {warehouse}: {correlation:.3f}")

import seaborn as sns
import matplotlib.pyplot as plt

# –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
corr_features = ['–ü—Ä–æ–¥–∞–∂–∏', 'tavg', '–û—Å—Ç–∞—Ç–∫–∏', '–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏', '–ú–µ—Å—è—Ü']
corr_matrix = df_final[corr_features].corr()

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
plt.figure(figsize=(8, 6))
sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', fmt='.2f', vmin=-1, vmax=1)
plt.title('–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤')
plt.show()

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime

# === 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ ===
file_path = "–ü—Ä–æ–¥–∞–∂–∏ —Å–æ —Å–∫–ª–∞–¥–æ–≤ 41175635.csv"
with open(file_path, 'r', encoding='utf-8') as f:
    lines = f.readlines()

# –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã –∏–∑ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
raw_dates = lines[0].strip().split(';')
dates = [d for d in raw_dates if '-' in d]

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–¥–∞
parsed_dates = []
current_year = 2021
last_month = 0

for d in dates:
    day, month = map(int, d.split('-'))
    if last_month == 12 and month == 1:
        current_year += 1
    try:
        dt = datetime(current_year, month, day)
        parsed_dates.append(dt)
        last_month = month
    except ValueError:
        parsed_dates.append(None)

date_map = pd.Series(parsed_dates)

# –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫
parsed_data = []
for line in lines[1:]:
    parts = line.strip().split(';')
    warehouse = parts[0]
    values = parts[1:]
    for i in range(0, len(values) - 1, 2):  # —à–∞–≥ 2: –ü—Ä–æ–¥–∞–∂–∏ / –û—Å—Ç–∞—Ç–∫–∏
        index = i // 2
        if index < len(date_map):
            sales = values[i]
            stock = values[i + 1]
            parsed_data.append((warehouse, index, date_map[index], sales, stock))

# === 2. –°–æ–∑–¥–∞–Ω–∏–µ DataFrame –ø–æ —Å–∫–ª–∞–¥–∞–º ===
df_wh = pd.DataFrame(parsed_data, columns=['–°–∫–ª–∞–¥', '–ò–Ω–¥–µ–∫—Å_–¥–∞—Ç—ã', '–î–∞—Ç–∞', '–ü—Ä–æ–¥–∞–∂–∏', '–û—Å—Ç–∞—Ç–∫–∏'])
df_wh = df_wh[df_wh['–°–∫–ª–∞–¥'] != '–°–∫–ª–∞–¥']  # —É–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
df_wh['–ü—Ä–æ–¥–∞–∂–∏'] = pd.to_numeric(df_wh['–ü—Ä–æ–¥–∞–∂–∏'], errors='coerce')
df_wh['–û—Å—Ç–∞—Ç–∫–∏'] = pd.to_numeric(df_wh['–û—Å—Ç–∞—Ç–∫–∏'], errors='coerce')

# –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –¥–∞—Ç—ã
df_wh = df_wh[df_wh['–î–∞—Ç–∞'].notna()]

# === 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ ===
df_wh['–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏'] = df_wh['–î–∞—Ç–∞'].dt.dayofweek
df_wh['–ú–µ—Å—è—Ü'] = df_wh['–î–∞—Ç–∞'].dt.month

# === 4. –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ===
weather_df = pd.read_csv("kazan.csv")
weather_df["date"] = pd.to_datetime(weather_df["date"])

# === 5. –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Å–∫–ª–∞–¥—ã ===
target_warehouses = ['–ö–∞–∑–∞–Ω—å WB']
df_filtered = df_wh[df_wh['–°–∫–ª–∞–¥'].isin(target_warehouses)].copy()

# === 6. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π ===
df_final = df_filtered.merge(weather_df[['date', 'tavg', 'prcp']], left_on='–î–∞—Ç–∞', right_on='date', how='left')
df_final.drop(columns='date', inplace=True)

# === 7. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ===
print(df_final.head())

# (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª
# df_final.to_csv("–∏—Ç–æ–≥_–ø—Ä–æ–¥–∞–∂–∏_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞.csv", index=False)

import seaborn as sns
import matplotlib.pyplot as plt

# === 1. –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–¥–∞–∂ –æ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∫–ª–∞–¥—É ===
for warehouse in df_final['–°–∫–ª–∞–¥'].unique():
    subset = df_final[df_final['–°–∫–ª–∞–¥'] == warehouse]

    plt.figure(figsize=(10, 5))
    sns.scatterplot(data=subset, x='tavg', y='–ü—Ä–æ–¥–∞–∂–∏', alpha=0.5)
    plt.title(f'–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂ –æ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã: {warehouse}')
    plt.xlabel('–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)')
    plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
    plt.grid(True)
    plt.show()

# === 2. –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∫–ª–∞–¥—É ===
for warehouse in df_final['–°–∫–ª–∞–¥'].unique():
    subset = df_final[df_final['–°–∫–ª–∞–¥'] == warehouse]
    correlation = subset[['–ü—Ä–æ–¥–∞–∂–∏', 'tavg']].corr().iloc[0, 1]
    print(f"–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ–∂–¥—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π –∏ –ø—Ä–æ–¥–∞–∂–∞–º–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞ {warehouse}: {correlation:.3f}")

import seaborn as sns
import matplotlib.pyplot as plt

# –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
corr_features = ['–ü—Ä–æ–¥–∞–∂–∏', 'tavg', '–û—Å—Ç–∞—Ç–∫–∏', '–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏', '–ú–µ—Å—è—Ü']
corr_matrix = df_final[corr_features].corr()

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
plt.figure(figsize=(8, 6))
sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', fmt='.2f', vmin=-1, vmax=1)
plt.title('–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤')
plt.show()

df_final['prcp']=df_final['prcp'].fillna(0)

import seaborn as sns
import matplotlib.pyplot as plt

# === 1. –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–¥–∞–∂ –æ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∫–ª–∞–¥—É ===
for warehouse in df_final['–°–∫–ª–∞–¥'].unique():
    subset = df_final[df_final['–°–∫–ª–∞–¥'] == warehouse]

    plt.figure(figsize=(10, 5))
    sns.scatterplot(data=subset, x='prcp', y='–ü—Ä–æ–¥–∞–∂–∏', alpha=0.5)
    plt.title(f'–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂ –æ—Ç –æ—Å–∞–¥–∫–æ–≤: {warehouse}')
    plt.xlabel('–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)')
    plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
    plt.grid(True)
    plt.show()

# === 2. –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∫–ª–∞–¥—É ===
for warehouse in df_final['–°–∫–ª–∞–¥'].unique():
    subset = df_final[df_final['–°–∫–ª–∞–¥'] == warehouse]
    correlation = subset[['–ü—Ä–æ–¥–∞–∂–∏', 'prcp']].corr().iloc[0, 1]
    print(f"–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ–∂–¥—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π –∏ –ø—Ä–æ–¥–∞–∂–∞–º–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞ {warehouse}: {correlation:.3f}")

import matplotlib.pyplot as plt
import pandas as pd

# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–∞—Ç–∞ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
df_final['–î–∞—Ç–∞'] = pd.to_datetime(df_final['–î–∞—Ç–∞'])

# –ó–∞–º–µ–Ω–∏–º NaN –≤ –æ—Å–∞–¥–∫–∞—Ö –Ω–∞ 0
df_final['prsr'] = df_final['prcp'].fillna(0)

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å–∫–ª–∞–¥—É
df_kol = df_final[df_final['–°–∫–ª–∞–¥'] == '–ö–∞–∑–∞–Ω—å WB']

# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
fig, ax1 = plt.subplots(figsize=(12, 6))

# –ü—Ä–æ–¥–∞–∂–∏
ax1.plot(df_kol['–î–∞—Ç–∞'], df_kol['–ü—Ä–æ–¥–∞–∂–∏'], color='blue', label='–ü—Ä–æ–¥–∞–∂–∏', marker='o')
ax1.set_xlabel('–î–∞—Ç–∞')
ax1.set_ylabel('–ü—Ä–æ–¥–∞–∂–∏', color='blue')
ax1.tick_params(axis='y', labelcolor='blue')

# –û—Å–∞–¥–∫–∏ (–≤—Ç–æ—Ä–∞—è –æ—Å—å)
ax2 = ax1.twinx()
ax2.plot(df_kol['–î–∞—Ç–∞'], df_kol['prcp'], color='green', label='–û—Å–∞–¥–∫–∏ (prcp)', marker='x')
ax2.set_ylabel('–û—Å–∞–¥–∫–∏ (mm)', color='green')
ax2.tick_params(axis='y', labelcolor='green')

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
plt.title('–î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –∏ –æ—Å–∞–¥–∫–æ–≤')
fig.tight_layout()
plt.grid(True)

df_kol.head(20)

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from math import sqrt
from sklearn.metrics import mean_absolute_error, mean_squared_error

# === 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
df = df_kol.copy()
df = df.sort_values('–î–∞—Ç–∞')
df = df.set_index('–î–∞—Ç–∞')
df = df.asfreq('D').fillna(0)

y = df['–ü—Ä–æ–¥–∞–∂–∏']
split_idx = int(len(y) * 0.8)
y_train, y_test = y[:split_idx], y[split_idx:]

# === 2. –§—É–Ω–∫—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ ===
def plot_forecast_full(y_train, y_test, y_pred, title):
    plt.figure(figsize=(14, 5))

    # –§–∞–∫—Ç
    plt.plot(y_train.index, y_train.values, label='–§–∞–∫—Ç (train)', color='blue')
    plt.plot(y_test.index, y_test.values, label='–§–∞–∫—Ç (test)', color='blue', linestyle='--')

    # –ü—Ä–æ–≥–Ω–æ–∑ (—Ç–æ–ª—å–∫–æ –Ω–∞ test)
    plt.plot(y_test.index, y_pred, label='–ü—Ä–æ–≥–Ω–æ–∑', color='orange', linestyle='--', marker='x')

    # –õ–∏–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞
    plt.axvline(x=y_test.index[0], color='black', linestyle=':', label='–ù–∞—á–∞–ª–æ –ø—Ä–æ–≥–Ω–æ–∑–∞')

    plt.title(title)
    plt.xlabel('–î–∞—Ç–∞')
    plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
    plt.legend()
    plt.grid(True)
    plt.tight_layout()
    plt.show()

# –ü—Ä–æ–≥–Ω–æ–∑
y_pred_naive = [y_train.iloc[-1]] * len(y_test)

# –ú–µ—Ç—Ä–∏–∫–∏
mae = mean_absolute_error(y_test, y_pred_naive)
rmse = sqrt(mean_squared_error(y_test, y_pred_naive))
mape = np.mean(np.abs((y_test - y_pred_naive) / y_test.replace(0, np.nan))) * 100
print(f"Naive ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}, MAPE: {mape:.2f}%")

# –ì—Ä–∞—Ñ–∏–∫
plot_forecast_full(y_train, y_test, y_pred_naive, 'Naive Forecast')

from statsmodels.tsa.arima.model import ARIMA

model = ARIMA(y_train, order=(5, 1, 0))
model_fit = model.fit()
y_pred_arima = model_fit.forecast(steps=len(y_test))

mae = mean_absolute_error(y_test, y_pred_arima)
rmse = sqrt(mean_squared_error(y_test, y_pred_arima))
mape = np.mean(np.abs((y_test - y_pred_arima) / y_test.replace(0, np.nan))) * 100
print(f"ARIMA ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}, MAPE: {mape:.2f}%")
plot_forecast_full(y_train, y_test, y_pred_arima, 'ARIMA Forecast')

from prophet import Prophet

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
df_prophet = y.reset_index()
df_prophet.columns = ['ds', 'y']
model = Prophet()
model.fit(df_prophet.iloc[:split_idx])

future = model.make_future_dataframe(periods=len(y_test))
forecast = model.predict(future)

y_pred_prophet = forecast['yhat'].iloc[split_idx:].values
y_true_prophet = df_prophet['y'].iloc[split_idx:].values
y_test_prophet = pd.Series(y_true_prophet, index=y_test.index)

mae = mean_absolute_error(y_true_prophet, y_pred_prophet)
rmse = sqrt(mean_squared_error(y_true_prophet, y_pred_prophet))
mape = np.mean(np.abs((y_true_prophet - y_pred_prophet) / np.where(y_true_prophet == 0, np.nan, y_true_prophet))) * 100
print(f"Prophet ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}, MAPE: {mape:.2f}%")
y_test_prophet = pd.Series(y_true_prophet, index=y_test.index)
plot_forecast_full(y_train, y_test_prophet, y_pred_prophet, 'Prophet Forecast')

from sklearn.ensemble import RandomForestRegressor

# –°–æ–∑–¥–∞—ë–º –ª–∞–≥–∏
df_features = df[['–ü—Ä–æ–¥–∞–∂–∏', 'tavg', 'prcp']].copy()
for lag in range(1, 8):
    df_features[f'lag_{lag}'] = df_features['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)

df_features = df_features.dropna()

X = df_features.drop(columns='–ü—Ä–æ–¥–∞–∂–∏')
y = df_features['–ü—Ä–æ–¥–∞–∂–∏']

split_idx = int(len(X) * 0.8)
X_train, X_test = X[:split_idx], X[split_idx:]
y_train, y_test = y[:split_idx], y[split_idx:]

rf = RandomForestRegressor(n_estimators=100, random_state=42)
rf.fit(X_train, y_train)
y_pred_rf = rf.predict(X_test)

mae = mean_absolute_error(y_test, y_pred_rf)
rmse = sqrt(mean_squared_error(y_test, y_pred_rf))
mape = np.mean(np.abs((y_test - y_pred_rf) / np.where(y_test == 0, np.nan, y_test))) * 100
print(f"RandomForest ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}, MAPE: {mape:.2f}%")

plot_forecast_full(y_train, y_test, y_pred_rf, 'RandomForest Forecast')

"""üìä –ß—Ç–æ –∑–Ω–∞—á–∞—Ç –º–µ—Ç—Ä–∏–∫–∏ RandomForest:
‚úÖ MAE (Mean Absolute Error): 15.13
‚Üí –í —Å—Ä–µ–¥–Ω–µ–º –º–æ–¥–µ–ª—å –æ—à–∏–±–∞–µ—Ç—Å—è –Ω–∞ 15 –ø—Ä–æ–¥–∞–∂ –≤ –∫–∞–∂–¥–æ–º –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–º –¥–Ω–µ.

‚úÖ RMSE (Root Mean Squared Error): 34.10
‚Üí –û—à–∏–±–∫–∞ —Å —É—á—ë—Ç–æ–º ¬´—à—Ç—Ä–∞—Ñ–∞¬ª –∑–∞ –∫—Ä—É–ø–Ω—ã–µ –ø—Ä–æ–º–∞—Ö–∏. –ú–æ–¥–µ–ª—å –∏–Ω–æ–≥–¥–∞ –æ—à–∏–±–∞–µ—Ç—Å—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ ‚Äî –Ω–∞ 30+ —à—Ç—É–∫.

‚ö†Ô∏è MAPE (Mean Absolute Percentage Error): 286.01%
‚Üí –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤ —Å—Ä–µ–¥–Ω–µ–º –º–æ–¥–µ–ª—å –æ—à–∏–±–∞–µ—Ç—Å—è –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 286% –æ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è. –≠—Ç–æ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ.

üí° –ü–æ—á–µ–º—É —Ç–∞–∫–æ–π –≤—ã—Å–æ–∫–∏–π MAPE?
–ü–æ—Ç–æ–º—É —á—Ç–æ –≤ –¥–∞–Ω–Ω—ã—Ö –º–Ω–æ–≥–æ –Ω—É–ª–µ–π –∏–ª–∏ –º–∞–ª—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π:

python
Copy
Edit
df_kol1['–ü—Ä–æ–¥–∞–∂–∏'].describe()
–ï—Å–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:

—Ñ–∞–∫—Ç = 3, –∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–æ 12, —Ç–æ:

MAPE
=
‚à£
12
‚àí
3
3
‚à£
=
3
‚áí
300
%
MAPE=
‚Äã
  
3
12‚àí3
‚Äã
  
‚Äã
 =3‚áí300%
–¢–∞–∫–∂–µ:

–ø—Ä–∏ —Ñ–∞–∫—Ç–µ = 0 –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å ‚Üí —ç—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è .replace(0, np.nan), –Ω–æ –∏—Å–∫–∞–∂–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ.

‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å:
–°—Ä–∞–≤–Ω–∏ MAPE –∏ MAE. –ï—Å–ª–∏ MAPE –≤—ã—Å–æ–∫–∏–π, –∞ MAE —Ä–∞–∑—É–º–Ω—ã–π ‚Äî –º–æ–¥–µ–ª—å –Ω–µ —Ç–∞–∫ –ø–ª–æ—Ö–∞, –ø—Ä–æ—Å—Ç–æ –≤ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ –ø—Ä–æ–¥–∞–∂ –∏–ª–∏ –º–Ω–æ–≥–æ –Ω—É–ª–µ–π.

–ü–æ–ø—Ä–æ–±—É–π SMAPE –∏–ª–∏ MAE/RMSE ‚Äî –æ–Ω–∏ –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤—ã –∫ –Ω—É–ª—è–º.

–í–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å –≥—Ä–∞—Ñ–∏–∫: –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ —Ç—Ä–µ–Ω–¥–∞ –æ–∫, –∑–Ω–∞—á–∏—Ç –º–æ–¥–µ–ª—å ¬´—á—É–≤—Å—Ç–≤—É–µ—Ç¬ª –¥–∞–Ω–Ω—ã–µ.
"""

from datetime import timedelta
import numpy as np

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
df_all = df_kol.copy().sort_values('–î–∞—Ç–∞').set_index('–î–∞—Ç–∞').asfreq('D').fillna(0)
weather = weather_df.set_index('date').sort_index().asfreq('D').fillna(method='ffill')

# Train –¥–æ 1 –º–∞—Ä—Ç–∞
train_cutoff = pd.to_datetime('2025-03-01')
df_train = df_all[df_all.index < train_cutoff].copy()

# –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
df_features = df_train[['–ü—Ä–æ–¥–∞–∂–∏', 'tavg', 'prcp']].copy()
for lag in range(1, 8):
    df_features[f'lag_{lag}'] = df_features['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)
df_features.dropna(inplace=True)

X_train = df_features.drop(columns='–ü—Ä–æ–¥–∞–∂–∏')
y_train = df_features['–ü—Ä–æ–¥–∞–∂–∏']

rf = RandomForestRegressor(n_estimators=100, random_state=42)
rf.fit(X_train, y_train)

# –ù–∞—á–∞–ª—å–Ω—ã–µ –ª–∞–≥–∏ = –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π —Ñ–µ–≤—Ä–∞–ª—è
last_known = df_all.loc[:train_cutoff - timedelta(days=1)].tail(7)['–ü—Ä–æ–¥–∞–∂–∏'].tolist()

# –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–∞—Ä—Ç
forecast_dates = pd.date_range('2025-03-01', '2025-03-31')
predictions = []

for date in forecast_dates:
    row = {
        'tavg': weather.loc[date, 'tavg'] if date in weather.index else 0,
        'prcp': weather.loc[date, 'prcp'] if date in weather.index else 0,
    }
    for i in range(1, 8):
        row[f'lag_{i}'] = last_known[-i]

    X_input = pd.DataFrame([row])
    y_pred = rf.predict(X_input)[0]
    predictions.append((date, y_pred))

    # –û–±–Ω–æ–≤–ª—è–µ–º –ª–∞–≥–∏: –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    last_known.append(y_pred)

# –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑
df_forecast = pd.DataFrame(predictions, columns=['–î–∞—Ç–∞', '–ü—Ä–æ–≥–Ω–æ–∑'])
df_forecast.set_index('–î–∞—Ç–∞', inplace=True)

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ñ–∞–∫—Ç–∞–º–∏
df_compare = df_all.loc['2025-03-01':'2025-03-31'][['–ü—Ä–æ–¥–∞–∂–∏']].copy()
df_compare['–ü—Ä–æ–≥–Ω–æ–∑'] = df_forecast['–ü—Ä–æ–≥–Ω–æ–∑']

# –ú–µ—Ç—Ä–∏–∫–∏
from sklearn.metrics import mean_absolute_error, mean_squared_error
mae = mean_absolute_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑'])
rmse = np.sqrt(mean_squared_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑']))
print(f"–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–∞—Ä—Ç 2025 ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}")

# –ì—Ä–∞—Ñ–∏–∫
plt.figure(figsize=(14, 5))
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç')
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–≥–Ω–æ–∑'], label='–ü—Ä–æ–≥–Ω–æ–∑', linestyle='--', marker='x')
plt.axvline(pd.to_datetime('2025-03-01'), color='black', linestyle=':', label='–°—Ç–∞—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞')
plt.title('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂ –Ω–∞ –º–∞—Ä—Ç 2025 (RandomForest + –ª–∞–≥–∏ + –ø–æ–≥–æ–¥–∞)')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error
import matplotlib.pyplot as plt
import numpy as np
from datetime import timedelta

def plot_forecast_compare(df_compare, title):
    plt.figure(figsize=(14, 5))
    plt.plot(df_compare.index, df_compare['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç')
    plt.plot(df_compare.index, df_compare['–ü—Ä–æ–≥–Ω–æ–∑'], label='–ü—Ä–æ–≥–Ω–æ–∑', linestyle='--', marker='x')
    plt.axvline(pd.to_datetime('2025-03-01'), color='black', linestyle=':', label='–°—Ç–∞—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞')
    plt.title(title)
    plt.xlabel('–î–∞—Ç–∞')
    plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
    plt.grid(True)
    plt.legend()
    plt.tight_layout()
    plt.show()

df_all = df_kol.copy().sort_values('–î–∞—Ç–∞').set_index('–î–∞—Ç–∞').asfreq('D').fillna(0)

# –û–±—É—á–µ–Ω–∏–µ –¥–æ –º–∞—Ä—Ç–∞
cutoff = pd.to_datetime('2025-03-01')
df_train = df_all[df_all.index < cutoff].copy()
weather = weather_df.set_index('date').asfreq('D').fillna(method='ffill')

# –°–æ–∑–¥–∞–Ω–∏–µ –ª–∞–≥–æ–≤
df_feat = df_train[['–ü—Ä–æ–¥–∞–∂–∏']].copy()
for lag in range(1, 8):
    df_feat[f'lag_{lag}'] = df_feat['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)
df_feat.dropna(inplace=True)

X_train = df_feat.drop(columns='–ü—Ä–æ–¥–∞–∂–∏')
y_train = df_feat['–ü—Ä–æ–¥–∞–∂–∏']
rf = RandomForestRegressor(n_estimators=100, random_state=42)
rf.fit(X_train, y_train)

# –ü—Ä–æ–≥–Ω–æ–∑
last_lags = df_train['–ü—Ä–æ–¥–∞–∂–∏'].iloc[-7:].tolist()
forecast_dates = pd.date_range('2025-03-01', '2025-03-31')
preds = []

for d in forecast_dates:
    row = {f'lag_{i}': last_lags[-i] for i in range(1, 8)}
    X_input = pd.DataFrame([row])
    y_pred = rf.predict(X_input)[0]
    preds.append((d, y_pred))
    last_lags.append(y_pred)

df_forecast = pd.DataFrame(preds, columns=['–î–∞—Ç–∞', '–ü—Ä–æ–≥–Ω–æ–∑']).set_index('–î–∞—Ç–∞')
df_compare = df_all.loc['2025-03-01':'2025-03-31'][['–ü—Ä–æ–¥–∞–∂–∏']].copy()
df_compare['–ü—Ä–æ–≥–Ω–æ–∑'] = df_forecast['–ü—Ä–æ–≥–Ω–æ–∑']

mae = mean_absolute_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑'])
rmse = np.sqrt(mean_squared_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑']))
print(f"–ë–µ–∑ –ø–æ–≥–æ–¥—ã ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}")
plot_forecast_compare(df_compare, "RandomForest –±–µ–∑ –ø–æ–≥–æ–¥—ã")

import pandas as pd
import numpy as np
from datetime import timedelta
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error

# === –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
df_all = df_kol.copy().sort_values('–î–∞—Ç–∞').set_index('–î–∞—Ç–∞').asfreq('D').fillna(0)
weather = weather_df.set_index('date').sort_index().asfreq('D').fillna(method='ffill')

# –°–æ–∑–¥–∞—ë–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
df_all['dayofweek'] = df_all.index.dayofweek
df_all['month'] = df_all.index.month
df_all['rolling_7'] = df_all['–ü—Ä–æ–¥–∞–∂–∏'].rolling(7).mean().shift(1)  # —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ

# –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å –ø–æ–≥–æ–¥–æ–π
df_all['tavg'] = weather['tavg']
df_all['prcp'] = weather['prcp']

# === Train –¥–æ –º–∞—Ä—Ç–∞ ===
cutoff = pd.to_datetime('2025-03-01')
df_train = df_all[df_all.index < cutoff].copy()

# === –õ–∞–≥–∏ ===
for lag in range(1, 8):
    df_train[f'lag_{lag}'] = df_train['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)

df_train = df_train.dropna()

# === –û–±—É—á–µ–Ω–∏–µ ===
feature_cols = [f'lag_{i}' for i in range(1, 8)] + ['tavg', 'prcp', 'dayofweek', 'month', 'rolling_7']
X_train = df_train[feature_cols]
y_train = df_train['–ü—Ä–æ–¥–∞–∂–∏']

rf = RandomForestRegressor(n_estimators=200, random_state=42)
rf.fit(X_train, y_train)

# === –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –¥–Ω—è–º –Ω–∞ –º–∞—Ä—Ç ===
last_lags = df_all.loc[:cutoff - timedelta(days=1)]['–ü—Ä–æ–¥–∞–∂–∏'].tail(7).tolist()
forecast_dates = pd.date_range('2025-03-01', '2025-03-31')
predictions = []

dow = cutoff.dayofweek  # –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ 1 –º–∞—Ä—Ç–∞
month = 3  # –º–µ—Å—è—Ü

for date in forecast_dates:
    row = {}

    # –õ–∞–≥–∏
    for i in range(1, 8):
        row[f'lag_{i}'] = last_lags[-i]

    # –ü–æ–≥–æ–¥–∞
    row['tavg'] = weather.loc[date, 'tavg'] if date in weather.index else 0
    row['prcp'] = weather.loc[date, 'prcp'] if date in weather.index else 0

    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
    row['dayofweek'] = dow % 7
    row['month'] = month

    # –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ
    row['rolling_7'] = np.mean(last_lags[-7:])

    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    X_input = pd.DataFrame([row])
    y_pred = rf.predict(X_input)[0]
    predictions.append((date, y_pred))

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∞–≥–æ–≤
    last_lags.append(y_pred)
    dow += 1

# === –†–µ–∑—É–ª—å—Ç–∞—Ç ===
df_forecast = pd.DataFrame(predictions, columns=['–î–∞—Ç–∞', '–ü—Ä–æ–≥–Ω–æ–∑']).set_index('–î–∞—Ç–∞')
df_compare = df_all.loc['2025-03-01':'2025-03-31'][['–ü—Ä–æ–¥–∞–∂–∏']].copy()
df_compare['–ü—Ä–æ–≥–Ω–æ–∑'] = df_forecast['–ü—Ä–æ–≥–Ω–æ–∑']

# === –ú–µ—Ç—Ä–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ===
mae = mean_absolute_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑'])
rmse = np.sqrt(mean_squared_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑']))
print(f"–ú–æ–¥–µ–ª—å (–ª–∞–≥–∏ + –ø–æ–≥–æ–¥–∞ + –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ + —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ) ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}")

plt.figure(figsize=(14, 5))
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç')
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–≥–Ω–æ–∑'], label='–ü—Ä–æ–≥–Ω–æ–∑', linestyle='--', marker='x')
plt.axvline(pd.to_datetime('2025-03-01'), color='black', linestyle=':', label='–°—Ç–∞—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞')
plt.title('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂ –Ω–∞ –º–∞—Ä—Ç 2025 (RF + –ª–∞–≥–∏ + –ø–æ–≥–æ–¥–∞ + –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ + —Å—Ä–µ–¥–Ω–µ–µ)')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

import pandas as pd
import numpy as np
from datetime import timedelta
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error

# === –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
df_all = df_kol.copy().sort_values('–î–∞—Ç–∞').set_index('–î–∞—Ç–∞').asfreq('D').fillna(0)

# –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
df_all['dayofweek'] = df_all.index.dayofweek
df_all['month'] = df_all.index.month

# Train –¥–æ 1 –º–∞—Ä—Ç–∞
cutoff = pd.to_datetime('2025-03-01')
df_train = df_all[df_all.index < cutoff].copy()

# –°–æ–∑–¥–∞–Ω–∏–µ –ª–∞–≥–æ–≤
for lag in range(1, 8):
    df_train[f'lag_{lag}'] = df_train['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)
df_train = df_train.dropna()

# –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
feature_cols = [f'lag_{i}' for i in range(1, 8)] + ['dayofweek', 'month']
X_train = df_train[feature_cols]
y_train = df_train['–ü—Ä–æ–¥–∞–∂–∏']

rf = RandomForestRegressor(n_estimators=200, random_state=42)
rf.fit(X_train, y_train)

# === –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–∞—Ä—Ç 2025 ===
last_lags = df_all.loc[:cutoff - timedelta(days=1)]['–ü—Ä–æ–¥–∞–∂–∏'].tail(7).tolist()
forecast_dates = pd.date_range('2025-03-01', '2025-03-31')
predictions = []

dow = cutoff.dayofweek
month = 3

for date in forecast_dates:
    row = {f'lag_{i}': last_lags[-i] for i in range(1, 8)}
    row['dayofweek'] = dow % 7
    row['month'] = month

    X_input = pd.DataFrame([row])
    y_pred = rf.predict(X_input)[0]
    predictions.append((date, y_pred))

    last_lags.append(y_pred)
    dow += 1

# === –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ñ–∞–∫—Ç–æ–º ===
df_forecast = pd.DataFrame(predictions, columns=['–î–∞—Ç–∞', '–ü—Ä–æ–≥–Ω–æ–∑']).set_index('–î–∞—Ç–∞')
df_compare = df_all.loc['2025-03-01':'2025-03-31'][['–ü—Ä–æ–¥–∞–∂–∏']].copy()
df_compare['–ü—Ä–æ–≥–Ω–æ–∑'] = df_forecast['–ü—Ä–æ–≥–Ω–æ–∑']

# === –ú–µ—Ç—Ä–∏–∫–∏ –∏ –≥—Ä–∞—Ñ–∏–∫ ===
mae = mean_absolute_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑'])
rmse = np.sqrt(mean_squared_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑']))
print(f"–ú–æ–¥–µ–ª—å (–ª–∞–≥–∏ + –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ + –º–µ—Å—è—Ü) ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}")

plt.figure(figsize=(14, 5))
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç')
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–≥–Ω–æ–∑'], label='–ü—Ä–æ–≥–Ω–æ–∑', linestyle='--', marker='x')
plt.axvline(pd.to_datetime('2025-03-01'), color='black', linestyle=':', label='–°—Ç–∞—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞')
plt.title('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂ –Ω–∞ –º–∞—Ä—Ç 2025 (–ª–∞–≥–∏ + –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ + –º–µ—Å—è—Ü)')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

import pandas as pd
import numpy as np
from datetime import timedelta
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error

# === –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
df_all = df_kol.copy().sort_values('–î–∞—Ç–∞').set_index('–î–∞—Ç–∞').asfreq('D').fillna(0)
weather = weather_df.set_index('date').sort_index().asfreq('D').fillna(method='ffill')

# –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏
df_all['dayofweek'] = df_all.index.dayofweek
df_all['month'] = df_all.index.month
df_all['rolling_7'] = df_all['–ü—Ä–æ–¥–∞–∂–∏'].rolling(7).mean().shift(1)
df_all['tavg'] = weather['tavg']
df_all['prcp'] = weather['prcp']

# === Train –¥–æ 1 —è–Ω–≤–∞—Ä—è 2025 ===
cutoff = pd.to_datetime('2025-01-01')
df_train = df_all[df_all.index < cutoff].copy()

# –°–æ–∑–¥–∞–Ω–∏–µ –ª–∞–≥–æ–≤
for lag in range(1, 8):
    df_train[f'lag_{lag}'] = df_train['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)
df_train = df_train.dropna()

# –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
feature_cols = [f'lag_{i}' for i in range(1, 8)] + ['tavg', 'prcp', 'dayofweek', 'month', 'rolling_7']
X_train = df_train[feature_cols]
y_train = df_train['–ü—Ä–æ–¥–∞–∂–∏']

rf = RandomForestRegressor(n_estimators=200, random_state=42)
rf.fit(X_train, y_train)

# === –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –≤–µ—Å—å 2025 –≥–æ–¥ ===
last_lags = df_all.loc[:cutoff - timedelta(days=1)]['–ü—Ä–æ–¥–∞–∂–∏'].tail(7).tolist()
forecast_dates = pd.date_range('2025-01-01', '2025-12-31')
predictions = []

dow = cutoff.dayofweek

for date in forecast_dates:
    row = {}

    # –õ–∞–≥–∏
    for i in range(1, 8):
        row[f'lag_{i}'] = last_lags[-i]

    # –ü–æ–≥–æ–¥–Ω—ã–µ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
    row['tavg'] = weather.loc[date, 'tavg'] if date in weather.index else 0
    row['prcp'] = weather.loc[date, 'prcp'] if date in weather.index else 0
    row['dayofweek'] = dow % 7
    row['month'] = date.month
    row['rolling_7'] = np.mean(last_lags[-7:])

    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    X_input = pd.DataFrame([row])
    y_pred = rf.predict(X_input)[0]
    predictions.append((date, y_pred))

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∞–≥–æ–≤
    last_lags.append(y_pred)
    dow += 1

# === –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é ===
df_forecast = pd.DataFrame(predictions, columns=['–î–∞—Ç–∞', '–ü—Ä–æ–≥–Ω–æ–∑']).set_index('–î–∞—Ç–∞')
df_compare = df_all.loc['2025-01-01':'2025-12-31'][['–ü—Ä–æ–¥–∞–∂–∏']].copy()
df_compare['–ü—Ä–æ–≥–Ω–æ–∑'] = df_forecast['–ü—Ä–æ–≥–Ω–æ–∑']

# === –ú–µ—Ç—Ä–∏–∫–∏ ===
mae = mean_absolute_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑'])
rmse = np.sqrt(mean_squared_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑']))
print(f"RandomForest ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}")

# === –ì—Ä–∞—Ñ–∏–∫ ===
plt.figure(figsize=(16, 6))
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç')
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–≥–Ω–æ–∑'], label='–ü—Ä–æ–≥–Ω–æ–∑', linestyle='--', marker='x', alpha=0.8)
plt.axvline(pd.to_datetime('2025-01-01'), color='black', linestyle=':', label='–°—Ç–∞—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞')
plt.title('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂ –Ω–∞ 2025 –≥–æ–¥ (RF + –ª–∞–≥–∏ + –ø–æ–≥–æ–¥–∞ + –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ + —Å—Ä–µ–¥–Ω–µ–µ)')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

!pip install xgboost

import pandas as pd
import numpy as np
from datetime import timedelta
import matplotlib.pyplot as plt
from sklearn.metrics import mean_absolute_error, mean_squared_error
from xgboost import XGBRegressor

# === –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ===
df_all = df_kol.copy().sort_values('–î–∞—Ç–∞').set_index('–î–∞—Ç–∞').asfreq('D').fillna(0)
df_all['dayofweek'] = df_all.index.dayofweek
df_all['month'] = df_all.index.month

# Train –¥–æ 01.01.2025
cutoff = pd.to_datetime('2025-01-01')
df_train = df_all[df_all.index < cutoff].copy()

# –õ–∞–≥–∏
for lag in range(1, 8):
    df_train[f'lag_{lag}'] = df_train['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)
df_train.dropna(inplace=True)

# –û–±—É—á–µ–Ω–∏–µ
features = [f'lag_{i}' for i in range(1, 8)] + ['dayofweek', 'month']
X_train = df_train[features]
y_train = df_train['–ü—Ä–æ–¥–∞–∂–∏']

xgb = XGBRegressor(n_estimators=300, learning_rate=0.05, max_depth=6, random_state=42)
xgb.fit(X_train, y_train)

# === –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –≤–µ—Å—å 2025 –≥–æ–¥ ===
last_lags = df_all.loc[:cutoff - timedelta(days=1)]['–ü—Ä–æ–¥–∞–∂–∏'].tail(7).tolist()
forecast_dates = pd.date_range('2025-01-01', '2025-12-31')
predictions = []

dow = cutoff.dayofweek
month = cutoff.month

for date in forecast_dates:
    row = {f'lag_{i}': last_lags[-i] for i in range(1, 8)}
    row['dayofweek'] = dow % 7
    row['month'] = date.month  # –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é

    X_input = pd.DataFrame([row])
    y_pred = xgb.predict(X_input)[0]
    predictions.append((date, y_pred))

    last_lags.append(y_pred)
    dow += 1

# === –°—Ä–∞–≤–Ω–µ–Ω–∏–µ ===
df_forecast = pd.DataFrame(predictions, columns=['–î–∞—Ç–∞', '–ü—Ä–æ–≥–Ω–æ–∑']).set_index('–î–∞—Ç–∞')
df_compare = df_all.loc['2025-01-01':'2025-12-31'][['–ü—Ä–æ–¥–∞–∂–∏']].copy()
df_compare['–ü—Ä–æ–≥–Ω–æ–∑'] = df_forecast['–ü—Ä–æ–≥–Ω–æ–∑']

# === –ú–µ—Ç—Ä–∏–∫–∏ ===
mae = mean_absolute_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑'])
rmse = np.sqrt(mean_squared_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑']))
print(f"XGBoost –Ω–∞ 2025 ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}")

# === –ì—Ä–∞—Ñ–∏–∫ ===
plt.figure(figsize=(16, 6))
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç')
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–≥–Ω–æ–∑'], label='–ü—Ä–æ–≥–Ω–æ–∑ (XGBoost)', linestyle='--', marker='x', alpha=0.7)
plt.axvline(pd.to_datetime('2025-01-01'), color='black', linestyle=':', label='–°—Ç–∞—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞')
plt.title('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂ –Ω–∞ 2025 –≥–æ–¥ (XGBoost + –ª–∞–≥–∏ + –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ + –º–µ—Å—è—Ü)')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

import pandas as pd

# === 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ ===
file_path = "–ü—Ä–æ–¥–∞–∂–∏ —Å–æ —Å–∫–ª–∞–¥–æ–≤ 41175635.csv"
with open(file_path, 'r', encoding='utf-8') as f:
    lines = f.readlines()

raw_dates = lines[0].strip().split(';')
dates = [d for d in raw_dates if '-' in d]

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–¥–∞
parsed_dates = []
current_year = 2021
last_month = 0

for d in dates:
    day, month = map(int, d.split('-'))
    if last_month == 12 and month == 1:
        current_year += 1
    try:
        dt = pd.to_datetime(f"{day}-{month}-{current_year}", dayfirst=True)
        parsed_dates.append(dt)
        last_month = month
    except:
        parsed_dates.append(None)

date_map = pd.Series(parsed_dates)

# –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫
parsed_data = []
for line in lines[1:]:
    parts = line.strip().split(';')
    warehouse = parts[0]
    values = parts[1:]
    for i in range(0, len(values) - 1, 2):
        index = i // 2
        if index < len(date_map):
            sales = values[i]
            stock = values[i + 1]
            parsed_data.append((warehouse, date_map[index], sales, stock))

# === 2. DataFrame –ø–æ —Å–∫–ª–∞–¥–∞–º ===
df_wh = pd.DataFrame(parsed_data, columns=['–°–∫–ª–∞–¥', '–î–∞—Ç–∞', '–ü—Ä–æ–¥–∞–∂–∏', '–û—Å—Ç–∞—Ç–∫–∏'])
df_wh = df_wh[df_wh['–°–∫–ª–∞–¥'].isin(['–ö–∞–∑–∞–Ω—å WB'])]
df_wh['–ü—Ä–æ–¥–∞–∂–∏'] = pd.to_numeric(df_wh['–ü—Ä–æ–¥–∞–∂–∏'], errors='coerce')
df_wh['–û—Å—Ç–∞—Ç–∫–∏'] = pd.to_numeric(df_wh['–û—Å—Ç–∞—Ç–∫–∏'], errors='coerce')
df_wh['–î–∞—Ç–∞'] = pd.to_datetime(df_wh['–î–∞—Ç–∞'])

# === 3. –¶–µ–Ω—ã –∏–∑ Excel ===
xls = pd.read_excel("WB - 41175635 - –ü—Ä–æ–¥–∞–∂–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∏ - 01.09.2021-17.04.2025 - (18.04.2025).xlsx", sheet_name="ag-grid")
xls['–î–∞—Ç–∞'] = pd.to_datetime(xls['–î–∞—Ç–∞'], errors='coerce')
xls = xls.rename(columns={'–¶–µ–Ω–∞ —Å –°–ü–ü, ‚ÇΩ': '–¶–µ–Ω–∞ —Å –°–ü–ü'})

# === 4. –ü–æ–≥–æ–¥–∞ ===
weather_df = pd.read_csv('kazan.csv')
weather_df['date'] = pd.to_datetime(weather_df['date'], errors='coerce')
weather_df = weather_df.rename(columns={'date': '–î–∞—Ç–∞'})

# === 5. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ–≥–æ ===
df_merged = df_wh.merge(xls[['–î–∞—Ç–∞', '–¶–µ–Ω–∞ —Å –°–ü–ü']], on='–î–∞—Ç–∞', how='left')
df_final_all = df_merged.merge(weather_df[['–î–∞—Ç–∞', 'tavg', 'prcp']], on='–î–∞—Ç–∞', how='left')

# === –†–µ–∑—É–ª—å—Ç–∞—Ç ===
print(df_final_all.head())

# (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# df_final_all.to_csv("–∏—Ç–æ–≥_–ø—Ä–æ–¥–∞–∂–∏_—Ü–µ–Ω–∞_–ø–æ–≥–æ–¥–∞.csv", index=False)

import pandas as pd
import numpy as np
from datetime import timedelta
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error

# === –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
df_all = df_final_all.copy().sort_values('–î–∞—Ç–∞').set_index('–î–∞—Ç–∞').asfreq('D').fillna(method='ffill')

# –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏
df_all['dayofweek'] = df_all.index.dayofweek
df_all['month'] = df_all.index.month
df_all['rolling_7'] = df_all['–ü—Ä–æ–¥–∞–∂–∏'].rolling(7).mean().shift(1)

# === Train –¥–æ 1 —è–Ω–≤–∞—Ä—è 2025 ===
cutoff = pd.to_datetime('2025-01-01')
df_train = df_all[df_all.index < cutoff].copy()

# –°–æ–∑–¥–∞–Ω–∏–µ –ª–∞–≥–æ–≤
for lag in range(1, 8):
    df_train[f'lag_{lag}'] = df_train['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)
df_train = df_train.dropna()

# === –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ ===
feature_cols = (
    [f'lag_{i}' for i in range(1, 8)] +
    ['tavg', 'prcp', 'dayofweek', 'month', 'rolling_7', '–¶–µ–Ω–∞ —Å –°–ü–ü']
)

X_train = df_train[feature_cols]
y_train = df_train['–ü—Ä–æ–¥–∞–∂–∏']

rf = RandomForestRegressor(n_estimators=200, random_state=42)
rf.fit(X_train, y_train)

# === –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –≤–µ—Å—å 2025 –≥–æ–¥ ===
last_lags = df_all.loc[:cutoff - timedelta(days=1)]['–ü—Ä–æ–¥–∞–∂–∏'].tail(7).tolist()
forecast_dates = pd.date_range('2025-01-01', '2025-12-31')
predictions = []

dow = cutoff.dayofweek

for date in forecast_dates:
    row = {}

    for i in range(1, 8):
        row[f'lag_{i}'] = last_lags[-i]

    # –ü–æ–≥–æ–¥–Ω—ã–µ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
    row['tavg'] = df_all.loc[date, 'tavg'] if date in df_all.index else 0
    row['prcp'] = df_all.loc[date, 'prcp'] if date in df_all.index else 0
    row['dayofweek'] = dow % 7
    row['month'] = date.month
    row['rolling_7'] = np.mean(last_lags[-7:])

    # –¶–µ–Ω–∞
    row['–¶–µ–Ω–∞ —Å –°–ü–ü'] = df_all.loc[date, '–¶–µ–Ω–∞ —Å –°–ü–ü'] if date in df_all.index else np.nan

    X_input = pd.DataFrame([row])
    y_pred = rf.predict(X_input.fillna(method='ffill'))[0]
    predictions.append((date, y_pred))

    last_lags.append(y_pred)
    dow += 1

# === –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é ===
df_forecast = pd.DataFrame(predictions, columns=['–î–∞—Ç–∞', '–ü—Ä–æ–≥–Ω–æ–∑']).set_index('–î–∞—Ç–∞')
df_compare = df_all.loc['2025-01-01':'2025-03-31'][['–ü—Ä–æ–¥–∞–∂–∏']].copy()
df_compare['–ü—Ä–æ–≥–Ω–æ–∑'] = df_forecast['–ü—Ä–æ–≥–Ω–æ–∑']

# === –ú–µ—Ç—Ä–∏–∫–∏ ===
mae = mean_absolute_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑'])
rmse = np.sqrt(mean_squared_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑']))
print(f"RandomForest —Å —É—á—ë—Ç–æ–º —Ü–µ–Ω—ã ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}")

# === –ì—Ä–∞—Ñ–∏–∫ ===
plt.figure(figsize=(16, 6))
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç')
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–≥–Ω–æ–∑'], label='–ü—Ä–æ–≥–Ω–æ–∑', linestyle='--', marker='x', alpha=0.8)
plt.axvline(pd.to_datetime('2025-01-01'), color='black', linestyle=':', label='–°—Ç–∞—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞')
plt.title('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂ –Ω–∞ 2025 –≥–æ–¥ (—Å —É—á—ë—Ç–æ–º —Ü–µ–Ω—ã —Å –°–ü–ü)')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

import pandas as pd
import numpy as np
from datetime import timedelta
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error

# === –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
df_all = df_final_all.copy().sort_values('–î–∞—Ç–∞').set_index('–î–∞—Ç–∞').asfreq('D').fillna(method='ffill')

# –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏
df_all['dayofweek'] = df_all.index.dayofweek
df_all['month'] = df_all.index.month
df_all['rolling_7'] = df_all['–ü—Ä–æ–¥–∞–∂–∏'].rolling(7).mean().shift(1)

# === Train –¥–æ 1 —è–Ω–≤–∞—Ä—è 2025 ===
cutoff = pd.to_datetime('2025-01-01')
df_train = df_all[df_all.index < cutoff].copy()

# –°–æ–∑–¥–∞–Ω–∏–µ –ª–∞–≥–æ–≤
for lag in range(1, 8):
    df_train[f'lag_{lag}'] = df_train['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)
df_train = df_train.dropna()

# –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
feature_cols = (
    [f'lag_{i}' for i in range(1, 8)] +
    ['tavg', 'prcp', 'dayofweek', 'month', 'rolling_7', '–¶–µ–Ω–∞ —Å –°–ü–ü']
)
X_train = df_train[feature_cols]
y_train = df_train['–ü—Ä–æ–¥–∞–∂–∏']

rf = RandomForestRegressor(n_estimators=200, random_state=42)
rf.fit(X_train, y_train)

# === –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —è–Ω–≤–∞—Ä—å-—Ñ–µ–≤—Ä–∞–ª—å 2025 ===
last_lags = df_all.loc[:cutoff - timedelta(days=1)]['–ü—Ä–æ–¥–∞–∂–∏'].tail(7).tolist()
forecast_dates = pd.date_range('2025-01-01', '2025-02-28')
predictions = []

dow = cutoff.dayofweek

for date in forecast_dates:
    row = {}

    for i in range(1, 8):
        row[f'lag_{i}'] = last_lags[-i]

    row['tavg'] = df_all.loc[date, 'tavg'] if date in df_all.index else 0
    row['prcp'] = df_all.loc[date, 'prcp'] if date in df_all.index else 0
    row['dayofweek'] = dow % 7
    row['month'] = date.month
    row['rolling_7'] = np.mean(last_lags[-7:])
    row['–¶–µ–Ω–∞ —Å –°–ü–ü'] = df_all.loc[date, '–¶–µ–Ω–∞ —Å –°–ü–ü'] if date in df_all.index else np.nan

    X_input = pd.DataFrame([row])
    y_pred = rf.predict(X_input.ffill())[0]

    predictions.append((date, y_pred))

    last_lags.append(y_pred)
    dow += 1

# === –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ñ–∞–∫—Ç–∞–º–∏ ===
df_forecast = pd.DataFrame(predictions, columns=['–î–∞—Ç–∞', '–ü—Ä–æ–≥–Ω–æ–∑']).set_index('–î–∞—Ç–∞')
df_compare = df_all.loc['2025-01-01':'2025-02-28'][['–ü—Ä–æ–¥–∞–∂–∏']].copy()
df_compare['–ü—Ä–æ–≥–Ω–æ–∑'] = df_forecast['–ü—Ä–æ–≥–Ω–æ–∑']

# === –ú–µ—Ç—Ä–∏–∫–∏ ===
mae = mean_absolute_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑'])
rmse = np.sqrt(mean_squared_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑']))
print(f"–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —è–Ω–≤–∞—Ä—å‚Äì—Ñ–µ–≤—Ä–∞–ª—å 2025 ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}")

# === –ì—Ä–∞—Ñ–∏–∫ ===
plt.figure(figsize=(14, 5))
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç')
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–≥–Ω–æ–∑'], label='–ü—Ä–æ–≥–Ω–æ–∑', linestyle='--', marker='x', alpha=0.8)
plt.axvline(pd.to_datetime('2025-01-01'), color='black', linestyle=':', label='–°—Ç–∞—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞')
plt.title('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂ –Ω–∞ —è–Ω–≤–∞—Ä—å‚Äì—Ñ–µ–≤—Ä–∞–ª—å 2025 (—Å —Ü–µ–Ω–æ–π, –ø–æ–≥–æ–¥–æ–π, –ª–∞–≥–∞–º–∏)')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

MAE = 5.98 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤ —Å—Ä–µ–¥–Ω–µ–º –º–æ–¥–µ–ª—å –æ—à–∏–±–∞–µ—Ç—Å—è –Ω–∞ 6 –µ–¥–∏–Ω–∏—Ü –ø—Ä–æ–¥–∞–∂ –≤ –¥–µ–Ω—å.

RMSE = 6.72 ‚Äî —á—É—Ç—å –≤—ã—à–µ, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –Ω–∞–ª–∏—á–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö "–ø—Ä—ã–∂–∫–æ–≤" –∏–ª–∏ –≤—Å–ø–ª–µ—Å–∫–æ–≤, –≥–¥–µ –º–æ–¥–µ–ª—å –æ—à–∏–±–ª–∞—Å—å —Å–∏–ª—å–Ω–µ–µ –æ–±—ã—á–Ω–æ–≥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã—Ö–æ–¥–Ω–æ–π, –∞–∫—Ü–∏—è –∏ —Ç.–¥.).

# –¢–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
df_corr = df_all[['–ü—Ä–æ–¥–∞–∂–∏', 'tavg', 'prcp', '–¶–µ–Ω–∞ —Å –°–ü–ü', 'dayofweek', 'month', 'rolling_7']].copy()

# –£–¥–∞–ª–∏–º –ø—Ä–æ–ø—É—Å–∫–∏
df_corr = df_corr.dropna()

# –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞
corr_matrix = df_corr.corr()

# –ü–µ—á–∞—Ç—å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø—Ä–æ–¥–∞–∂ —Å –¥—Ä—É–≥–∏–º–∏
print(corr_matrix['–ü—Ä–æ–¥–∞–∂–∏'].sort_values(ascending=False))

"""rolling_7 (—Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ): —Å–∏–ª—å–Ω–∞—è –ø—Ä—è–º–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å ‚Äî —á–µ–º –≤—ã—à–µ –Ω–µ–¥–∞–≤–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏, —Ç–µ–º –≤—ã—à–µ —Ç–µ–∫—É—â–∏–µ.

tavg (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞): —É–º–µ—Ä–µ–Ω–Ω–∞—è —Å–≤—è–∑—å ‚Äî —á–µ–º —Ç–µ–ø–ª–µ–µ, —Ç–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–¥–∞–∂.

–¶–µ–Ω–∞ —Å –°–ü–ü: —Å–ª–∞–±–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –º–æ–∂–µ—Ç —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–ø—Ä–æ—Å.

prcp, dayofweek: –ø–æ—á—Ç–∏ –Ω–µ –≤–ª–∏—è—é—Ç –ª–∏–Ω–µ–π–Ω–æ, –º–æ–≥—É—Ç –¥–∞–≤–∞—Ç—å —Å–ª–∞–±—ã–π —ç—Ñ—Ñ–µ–∫—Ç –∏–ª–∏ –Ω–µ–ª–∏–Ω–µ–π–Ω—ã–π.
"""

importances = rf.feature_importances_
features = X_train.columns

# –í—ã–≤–æ–¥ –ø–æ —É–±—ã–≤–∞–Ω–∏—é –≤–∞–∂–Ω–æ—Å—Ç–∏
feature_importance = pd.Series(importances, index=features).sort_values(ascending=False)
print(feature_importance)

"""lag_1 ‚Äî —Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è —Ñ–∏—á–∞, –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Å–∏–ª—å–Ω–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ —Å–ø—Ä–æ—Å–∞.

dayofweek, tavg ‚Äî –∑–Ω–∞—á–∏–º—ã–µ: –º–æ–¥–µ–ª—å —É–ª–∞–≤–ª–∏–≤–∞–µ—Ç —Ü–∏–∫–ª—ã –ø–æ –¥–Ω—è–º –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã.

–¶–µ–Ω–∞ —Å –°–ü–ü: –≤–ª–∏—è–µ—Ç, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ ‚Äî —Å–∫–æ—Ä–µ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–∞—Ä–µ —Å –¥—Ä—É–≥–∏–º–∏ —Ñ–∏—á–∞–º–∏.

month, prcp: –ø–æ—á—Ç–∏ –Ω–µ –Ω—É–∂–Ω—ã ‚Äî –ª–∏–±–æ –∏—Ö –≤–ª–∏—è–Ω–∏–µ —Å–ª–∞–±–æ, –ª–∏–±–æ —à—É–º–æ–≤–æ–µ
"""

import pandas as pd
import numpy as np
from datetime import timedelta
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error

# === –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
df_all = df_final_all.copy().sort_values('–î–∞—Ç–∞').set_index('–î–∞—Ç–∞').asfreq('D').ffill()

# –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏
df_all['dayofweek'] = df_all.index.dayofweek
df_all['month'] = df_all.index.month
df_all['rolling_7'] = df_all['–ü—Ä–æ–¥–∞–∂–∏'].rolling(7).mean().shift(1)

# === Train –¥–æ 1 —è–Ω–≤–∞—Ä—è 2024 ===
cutoff = pd.to_datetime('2024-01-01')
df_train = df_all[df_all.index < cutoff].copy()

# –°–æ–∑–¥–∞–Ω–∏–µ –ª–∞–≥–æ–≤
for lag in range(1, 8):
    df_train[f'lag_{lag}'] = df_train['–ü—Ä–æ–¥–∞–∂–∏'].shift(lag)
df_train = df_train.dropna()

# –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
feature_cols = (
    [f'lag_{i}' for i in range(1, 8)] +
    ['tavg', 'prcp', 'dayofweek', 'month', 'rolling_7', '–¶–µ–Ω–∞ —Å –°–ü–ü']
)
X_train = df_train[feature_cols]
y_train = df_train['–ü—Ä–æ–¥–∞–∂–∏']

rf = RandomForestRegressor(n_estimators=200, random_state=42)
rf.fit(X_train, y_train)

# === –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –≤–µ—Å—å 2024 –≥–æ–¥ ===
last_lags = df_all.loc[:cutoff - timedelta(days=1)]['–ü—Ä–æ–¥–∞–∂–∏'].tail(7).tolist()
forecast_dates = pd.date_range('2024-01-01', '2024-12-31')
predictions = []

dow = cutoff.dayofweek

for date in forecast_dates:
    row = {}

    for i in range(1, 8):
        row[f'lag_{i}'] = last_lags[-i]

    row['tavg'] = df_all.loc[date, 'tavg'] if date in df_all.index else 0
    row['prcp'] = df_all.loc[date, 'prcp'] if date in df_all.index else 0
    row['dayofweek'] = dow % 7
    row['month'] = date.month
    row['rolling_7'] = np.mean(last_lags[-7:])
    row['–¶–µ–Ω–∞ —Å –°–ü–ü'] = df_all.loc[date, '–¶–µ–Ω–∞ —Å –°–ü–ü'] if date in df_all.index else np.nan

    X_input = pd.DataFrame([row])
    y_pred = rf.predict(X_input.ffill())[0]

    predictions.append((date, y_pred))

    last_lags.append(y_pred)
    dow += 1

# === –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ñ–∞–∫—Ç–∞–º–∏ ===
df_forecast = pd.DataFrame(predictions, columns=['–î–∞—Ç–∞', '–ü—Ä–æ–≥–Ω–æ–∑']).set_index('–î–∞—Ç–∞')
df_compare = df_all.loc['2024-01-01':'2024-12-31'][['–ü—Ä–æ–¥–∞–∂–∏']].copy()
df_compare['–ü—Ä–æ–≥–Ω–æ–∑'] = df_forecast['–ü—Ä–æ–≥–Ω–æ–∑']

# === –ú–µ—Ç—Ä–∏–∫–∏ ===
mae = mean_absolute_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑'])
rmse = np.sqrt(mean_squared_error(df_compare['–ü—Ä–æ–¥–∞–∂–∏'], df_compare['–ü—Ä–æ–≥–Ω–æ–∑']))
print(f"–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 2024 –≥–æ–¥ ‚Üí MAE: {mae:.2f}, RMSE: {rmse:.2f}")

# === –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ===
plt.figure(figsize=(16, 6))
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–¥–∞–∂–∏'], label='–§–∞–∫—Ç')
plt.plot(df_compare.index, df_compare['–ü—Ä–æ–≥–Ω–æ–∑'], label='–ü—Ä–æ–≥–Ω–æ–∑', linestyle='--', marker='x', alpha=0.8)
plt.axvline(pd.to_datetime('2024-01-01'), color='black', linestyle=':', label='–°—Ç–∞—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞')
plt.title('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂ –Ω–∞ 2024 –≥–æ–¥ (—Å –ª–∞–≥–∞–º–∏, –ø–æ–≥–æ–¥–æ–π, —Ü–µ–Ω–æ–π —Å –°–ü–ü)')
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–ü—Ä–æ–¥–∞–∂–∏')
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()